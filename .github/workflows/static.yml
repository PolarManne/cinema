name: Deploy optimized static content to Pages  
  
on:  
  # Runs on pushes targeting the default branch  
  push:  
    branches: ["master"]  
  
  # Allows you to run this workflow manually from the Actions tab  
  workflow_dispatch:  
  
# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages  
permissions:  
  contents: read  
  pages: write  
  id-token: write  
  
# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.  
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.  
concurrency:  
  group: "pages"  
  cancel-in-progress: false  
  
jobs:  
  # Build and deploy job with optimization  
  build-and-deploy:  
    environment:  
      name: github-pages  
      url: ${{ steps.deployment.outputs.page_url }}  
    runs-on: ubuntu-latest  
    steps:  
      - name: Checkout  
        uses: actions/checkout@v4  
          
      - name: Setup Node.js  
        uses: actions/setup-node@v4  
        with:  
          node-version: '18'  
            
      - name: Install minification tools  
        run: |  
          npm install -g html-minifier-terser clean-css-cli terser  
            
      - name: Create optimized directory  
        run: |  
          mkdir -p optimized  
          cp -r public/* optimized/  
            
      - name: Measure original sizes  
        run: |  
          echo "## Original File Sizes" >> size_comparison.md  
          echo "| File | Size |" >> size_comparison.md  
          echo "|------|------|" >> size_comparison.md  
          find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec sh -c 'echo "| {} | $(du -h "$1" | cut -f1) |"' _ {} \; >> size_comparison.md  
            
      - name: Minify HTML files  
        run: |  
          find optimized -name "*.html" -type f -exec html-minifier-terser \  
            --collapse-whitespace \  
            --remove-comments \  
            --remove-optional-tags \  
            --remove-redundant-attributes \  
            --remove-script-type-attributes \  
            --remove-tag-whitespace \  
            --use-short-doctype \  
            --minify-css true \  
            --minify-js true \  
            --output {} {} \;  
              
      - name: Minify CSS files  
        run: |  
          find optimized -name "*.css" -type f -exec sh -c 'cleancss -o "$1" "$1"' _ {} \;  
            
      - name: Minify JavaScript files  
        run: |  
          find optimized -name "*.js" -type f -exec sh -c 'terser "$1" --compress --mangle --output "$1"' _ {} \;  
            
      - name: Measure optimized sizes and calculate savings  
        run: |  
          echo "" >> size_comparison.md  
          echo "## Optimized File Sizes" >> size_comparison.md  
          echo "| File | Size | Savings |" >> size_comparison.md  
          echo "|------|------|---------|" >> size_comparison.md  
            
          for file in $(find optimized -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \)); do  
            original_file="public/${file#optimized/}"  
            if [ -f "$original_file" ]; then  
              original_size=$(stat -c%s "$original_file")  
              optimized_size=$(stat -c%s "$file")  
              savings=$((original_size - optimized_size))  
              savings_percent=$(( savings * 100 / original_size ))  
              echo "| $file | $(du -h "$file" | cut -f1) | ${savings_percent}% ($(numfmt --to=iec $savings)) |" >> size_comparison.md  
            fi  
          done  
            
          # Calculate total savings  
          original_total=$(find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')  
          optimized_total=$(find optimized -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')  
          total_savings=$((original_total - optimized_total))  
          total_savings_percent=$(( total_savings * 100 / original_total ))  
            
          echo "" >> size_comparison.md  
          echo "## Total Savings" >> size_comparison.md  
          echo "- Original total: $(numfmt --to=iec $original_total)" >> size_comparison.md  
          echo "- Optimized total: $(numfmt --to=iec $optimized_total)" >> size_comparison.md  
          echo "- Total savings: ${total_savings_percent}% ($(numfmt --to=iec $total_savings))" >> size_comparison.md  
            
      - name: Display size comparison  
        run: cat size_comparison.md  
          
      - name: Setup Pages  
        uses: actions/configure-pages@v5  
          
      - name: Upload artifact  
        uses: actions/upload-pages-artifact@v3  
        with:  
          path: 'optimized/'  
            
      - name: Deploy to GitHub Pages  
        id: deployment  
        uses: actions/deploy-pages@v4